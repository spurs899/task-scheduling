name: Scheduled Azure API Call

# Schedule the workflow to run at specific times
# Adjust the cron schedule as needed
on:
  schedule:
    # Runs every day at 8:00 AM UTC
    - cron: '0 8 * * *'
  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:

jobs:
  call-azure-api:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Call Azure Web API
        env:
          # Add your Azure API endpoint as a GitHub secret
          AZURE_API_URL: ${{ secrets.AZURE_API_URL }}
          # Add your API key or authentication token as a GitHub secret
          AZURE_API_KEY: ${{ secrets.AZURE_API_KEY }}
        run: |
          echo "Calling Azure Web API..."

          # Make HTTP request to Azure API
          # Replace with your specific API endpoint and method
          response=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${AZURE_API_KEY}" \
            -d '{"action": "scheduled-task"}' \
            "${AZURE_API_URL}")

          # Extract HTTP status code
          http_code=$(echo "$response" | tail -n 1)
          body=$(echo "$response" | head -n -1)

          echo "HTTP Status Code: ${http_code}"
          echo "Response Body: ${body}"

          # Check if the request was successful (2xx status code)
          if [[ ${http_code} -ge 200 && ${http_code} -lt 300 ]]; then
            echo "✓ API call successful"
            exit 0
          else
            echo "✗ API call failed with status code ${http_code}"
            exit 1
          fi

      - name: Handle API call failure
        if: failure()
        run: |
          echo "Azure API call failed. Check logs for details."
          echo "Verify that:"
          echo "  1. AZURE_API_URL secret is set correctly"
          echo "  2. AZURE_API_KEY secret is valid"
          echo "  3. The Azure API endpoint is accessible"
